import { extractRegexesFromSource } from "./findRegex.mjs";
import safe from "safe-regex";
import fs from "fs";
import { spawnSync } from "child_process";

export function semgrep(func, ruleFile) {
    fs.writeFileSync("temp.js", func);
    const semgrep = spawnSync("semgrep", [`--config=${ruleFile}`, "--json", "./temp.js"]);
    fs.unlinkSync("temp.js");   // removes thr symlink from the filesystem unlinkSync(path)

    const result = JSON.parse(semgrep.stdout.toString()); // parse 
    const err = semgrep.stderr.toString();
    if (!result) {    // If the result is empty, error
        console.log(err);
    }
    const usefulInfo = result.results.map(el => {
        return {"ruleID": el.check_id,
                    "vulnVar": el.extra.metavars["$KEY"].abstract_content,
                    "loc": {
                        "start": {
                        "line": el.extra.metavars["$KEY"].start.line,
                        "column": el.extra.metavars["$KEY"].start.col
                        },
                        "end": {
                        "line": el.extra.metavars["$KEY"].end.line,
                        "column": el.extra.metavars["$KEY"].end.col
                        }
                    },
        }
    });

    return usefulInfo;
}

export function evilRegExes(func) {       // Function Definition - can be imported by other files
    try{
    
    	console.log("Function from detect file:",func);  // Debug
    	
   // Calls extractRegexesFromSource function from the file findRegex.mjs; passes arguments - func from detect file, null to the filename, sets the output of the function in iterator.
        const iterator = extractRegexesFromSource("const name = " + func, null);
        console.log("Output Iterator from findRegex.js file:",iterator);  
        
        const arr = Array.from(iterator).map(regex => regex.pattern); // Creates an array dynamically based on the iterator value and maps the regex to the regex pattern.
        
       console.log("Regex Pattern:",regex.pattern); // Debug
        
        return arr.filter(el => !safe(el));
    } catch(e) {         // Catch Block 
        console.error(e);
        return [];
    }
}
