const esprima = require("esprima");
const fs = require("fs");
const {allChildNodes} = require("./utils.js");


function splitInFuncNodes(fileStr, fileLink) {
    try{
    const tree = esprima.parseModule(fileStr, {range:true});
    const parsed = allChildNodes(tree);
    const funcNodes = parsed.filter(node => 
        node.type === "FunctionDeclaration" || node.type === "FunctionExpression"
    )
    return funcNodes

    }catch(error){
        // console.log(error);
        fs.appendFileSync("./errorFiles.txt", (fileLink + "\n"));
    }
    // console.log(parsed.body);
    
}

function extractFunctions(funcNodes, fileStr) {
    const ranges = funcNodes.map(node => node.range);
    // console.log(ranges);
    const functions = ranges.map(([start, end]) => {
        const funcText = fileStr.substring(start,end);
        return funcText.startsWith("(")
            ? `function ${funcText}`
            : funcText;
    });

    return functions;
}

async function getFunctions(fileString, fileLink){
   
    const funcNodes = splitInFuncNodes(fileString, fileLink);
    // console.log("funcNodes " + funcNodes);
    if(funcNodes) {
        const functions = extractFunctions(funcNodes, fileString);
        return functions;
    }
}

module.exports = { getFunctions };